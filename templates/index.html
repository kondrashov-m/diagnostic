<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–∫—É—Å—Ç–∏—á–µ—Å–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f0f0f0; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .upload-section { border: 2px dashed #ccc; padding: 40px; text-align: center; margin: 20px 0; }
        .upload-btn { background: #007cba; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; margin: 10px; }
        .upload-btn:disabled { background: #ccc; }
        .results { margin-top: 20px; }
        .result-card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .spectrogram-img { width: 100%; min-height: 200px; background: #f8f8f8; display: flex; align-items: center; justify-content: center; margin: 10px 0; }
        .spectrogram-img img { max-width: 100%; max-height: 300px; }
        .audio-player { width: 100%; margin: 10px 0; }
        .download-btn { background: #28a745; color: white; padding: 8px 15px; border-radius: 3px; text-decoration: none; margin: 5px; display: inline-block; }
        .error { background: #dc3545; color: white; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .success { background: #28a745; color: white; padding: 15px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîä –ê–∫—É—Å—Ç–∏—á–µ—Å–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h1>
        
        <div class="upload-section" id="uploadSection">
            <h2>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª</h2>
            <input type="file" id="fileInput" style="display: none;" accept=".wav,.mp3,.flac,.m4a,.aac">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
            </button>
            <p>WAV, MP3, FLAC, M4A, AAC (–¥–æ 16MB)</p>
        </div>

        <div>
            <strong>–£—Ä–æ–≤–µ–Ω—å —à—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏—è: <span id="noiseLevelValue">80%</span></strong>
            <input type="range" min="0" max="100" value="80" style="width: 100%" id="noiseLevel">
            <button class="upload-btn" onclick="processFile()" id="processBtn" disabled>
                –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–≤—É–∫
            </button>
        </div>

        <div id="loading" style="display: none; text-align: center;">
            <h3>–û–±—Ä–∞–±–æ—Ç–∫–∞...</h3>
        </div>

        <div class="error" id="error" style="display: none;"></div>
        <div class="success" id="success" style="display: none;"></div>

        <div class="results" id="results" style="display: none;">
            <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</h2>
            <div id="fileInfo" style="background: #eee; padding: 10px; margin: 10px 0;"></div>
            <div id="resultsGrid"></div>
        </div>
    </div>

    <script>
        let currentFile = null;

        document.getElementById('fileInput').addEventListener('change', function(e) {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        document.getElementById('noiseLevel').addEventListener('input', function() {
            document.getElementById('noiseLevelValue').textContent = this.value + '%';
        });

        function handleFile(file) {
            if (!file.type.match('audio.*')) {
                showError('–í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª!');
                return;
            }
            currentFile = file;
            document.getElementById('fileInfo').textContent = `–§–∞–π–ª: ${file.name} (${(file.size/1024/1024).toFixed(1)} MB)`;
            document.getElementById('processBtn').disabled = false;
            showSuccess('–§–∞–π–ª –≥–æ—Ç–æ–≤ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ');
        }

        async function processFile() {
            if (!currentFile) return;
            
            showLoading(true);
            const formData = new FormData();
            formData.append('file', currentFile);
            formData.append('noise_level', document.getElementById('noiseLevel').value / 100);

            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                const data = await response.json();
                
                if (!response.ok) throw new Error(data.error);
                displayResults(data);
                showSuccess('–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
            } catch (err) {
                showError(err.message);
            } finally {
                showLoading(false);
            }
        }

        function displayResults(data) {
            const resultsGrid = document.getElementById('resultsGrid');
            resultsGrid.innerHTML = '';

            const types = [
                { title: '–û—Ä–∏–≥–∏–Ω–∞–ª', key: 'original', desc: '–ò—Å—Ö–æ–¥–Ω—ã–π –∑–≤—É–∫' },
                { title: `–û—á–∏—â–µ–Ω–Ω—ã–π (${Math.round(data.noise_reduction_level * 100)}%)`, key: 'denoised', desc: '–ü–æ—Å–ª–µ —à—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏—è' },
                { title: '–£–¥–∞–ª–µ–Ω–Ω—ã–π —à—É–º', key: 'residual', desc: '–ß—Ç–æ –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ' }
            ];

            types.forEach(type => {
                const card = document.createElement('div');
                card.className = 'result-card';
                
                const spectrogram = data.spectrograms[type.key];
                
                card.innerHTML = `
                    <h3>${type.title}</h3>
                    <p>${type.desc}</p>
                    <div class="spectrogram-img">
                        ${spectrogram ? 
                            `<img src="${spectrogram}" alt="–°–ø–µ–∫—Ç—Ä–æ–≥—Ä–∞–º–º–∞">` :
                            '<div>–°–ø–µ–∫—Ç—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞</div>'
                        }
                    </div>
                    <audio controls class="audio-player">
                        <source src="data:audio/wav;base64,${data.preview_audio[type.key]}" type="audio/wav">
                    </audio>
                    <div>
                        <a href="${data.files[`${type.key}_audio`]}" class="download-btn" download>–°–∫–∞—á–∞—Ç—å –∞—É–¥–∏–æ</a>
                    </div>
                `;
                
                resultsGrid.appendChild(card);
            });

            document.getElementById('results').style.display = 'block';
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('processBtn').disabled = show;
        }

        function showError(msg) {
            document.getElementById('error').textContent = msg;
            document.getElementById('error').style.display = 'block';
            document.getElementById('success').style.display = 'none';
        }

        function showSuccess(msg) {
            document.getElementById('success').textContent = msg;
            document.getElementById('success').style.display = 'block';
            document.getElementById('error').style.display = 'none';
        }
    </script>
</body>
</html>