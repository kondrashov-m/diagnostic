<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–∫—É—Å—Ç–∏—á–µ—Å–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f0f0f0; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .upload-section { border: 2px dashed #ccc; padding: 40px; text-align: center; margin: 20px 0; }
        .upload-btn { background: #007cba; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; margin: 10px; }
        .upload-btn:disabled { background: #ccc; }
        .upload-btn.secondary { background: #6c757d; }
        .upload-btn.stream { background: #28a745; }
        .upload-btn.download { background: #ffc107; color: black; }
        .results { margin-top: 20px; }
        .result-card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .spectrogram-img { width: 100%; background: #f8f8f8; display: flex; align-items: center; justify-content: center; margin: 10px 0; }
        .spectrogram-img img { max-width: 100%; height: auto; }
        .audio-player { width: 100%; margin: 10px 0; }
        .download-btn { background: #28a745; color: white; padding: 8px 15px; border-radius: 3px; text-decoration: none; margin: 5px; display: inline-block; }
        .error { background: #dc3545; color: white; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .success { background: #28a745; color: white; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .file-list { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin: 10px 0; }
        .file-item { padding: 5px; border-bottom: 1px solid #eee; }
        .progress-bar { width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: #007cba; transition: width 0.3s; }
        .batch-summary { background: #e9ecef; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .file-section { border: 2px solid #007cba; border-radius: 10px; padding: 15px; margin: 20px 0; background: #f8f9fa; }
        .info-box { background: #d1ecf1; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .download-buttons { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; border: 2px solid #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîä –ê–∫—É—Å—Ç–∏—á–µ—Å–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h1>
        
        <div class="info-box">
            <strong>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong> –î–ª—è –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ñ–∞–π–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ <strong>–ø–æ—Ç–æ–∫–æ–≤—É—é –∑–∞–≥—Ä—É–∑–∫—É</strong>!
        </div>
        
        <div class="upload-section" id="uploadSection">
            <h2>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã</h2>
            <input type="file" id="fileInput" style="display: none;" accept=".wav,.mp3,.flac,.m4a,.aac" multiple>
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã
            </button>
            <button class="upload-btn secondary" onclick="clearFiles()">
                –û—á–∏—Å—Ç–∏—Ç—å
            </button>
            <p>WAV, MP3, FLAC, M4A, AAC</p>
            <div class="file-list" id="fileList" style="display: none;">
                <h4>–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã: <span id="fileCount">0</span></h4>
                <div id="fileItems"></div>
            </div>
        </div>

        <div>
            <strong>–£—Ä–æ–≤–µ–Ω—å —à—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏—è: <span id="noiseLevelValue">80%</span></strong>
            <input type="range" min="0" max="100" value="80" style="width: 100%" id="noiseLevel">
            
            <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="upload-btn" onclick="processFilesSimple()" id="simpleBtn" disabled>
                    –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (–¥–æ 5 —Ñ–∞–π–ª–æ–≤)
                </button>
                <button class="upload-btn stream" onclick="startStreamingUpload()" id="streamBtn" disabled>
                    üì¶ –ü–æ—Ç–æ–∫–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (–ª—é–±–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)
                </button>
            </div>
        </div>

        <div id="loading" style="display: none; text-align: center;">
            <h3>–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div id="progressText">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>
            <div id="chunkInfo" style="margin-top: 10px;"></div>
        </div>

        <div class="error" id="error" style="display: none;"></div>
        <div class="success" id="success" style="display: none;"></div>

        <div class="batch-summary" id="batchSummary" style="display: none;">
            <h3>–°–≤–æ–¥–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏</h3>
            <div id="summaryContent"></div>
            
            <!-- –ö–ù–û–ü–ö–ò –°–ö–ê–ß–ò–í–ê–ù–ò–Ø –°–ü–ï–ö–¢–†–û–ì–†–ê–ú–ú -->
            <div class="download-buttons" id="downloadButtons" style="display: none;">
                <h4>üì• –°–∫–∞—á–∞—Ç—å –≤—Å–µ —Å–ø–µ–∫—Ç—Ä–æ–≥—Ä–∞–º–º—ã –∞—Ä—Ö–∏–≤–æ–º:</h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="upload-btn download" onclick="downloadSpectrograms('original')">
                        üìä –°–∫–∞—á–∞—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–µ —Å–ø–µ–∫—Ç—Ä–æ–≥—Ä–∞–º–º—ã
                    </button>
                    <button class="upload-btn download" onclick="downloadSpectrograms('denoised')">
                        üîß –°–∫–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–ø–µ–∫—Ç—Ä–æ–≥—Ä–∞–º–º—ã
                    </button>
                    <button class="upload-btn download" onclick="downloadSpectrograms('residual')">
                        üéµ –°–∫–∞—á–∞—Ç—å —Å–ø–µ–∫—Ç—Ä–æ–≥—Ä–∞–º–º—ã —à—É–º–æ–≤
                    </button>
                </div>
            </div>
        </div>

        <div class="results" id="results" style="display: none;">
            <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã (–≤—Å–µ —Å–ø–µ–∫—Ç—Ä–æ–≥—Ä–∞–º–º—ã —Å–æ–∑–¥–∞–Ω—ã!):</h2>
            <div id="resultsGrid"></div>
        </div>
    </div>

    <script>
        let currentFiles = [];
        let currentSessionId = null;
        let isProcessing = false;

        document.getElementById('fileInput').addEventListener('change', function(e) {
            if (e.target.files.length) handleFiles(e.target.files);
        });

        document.getElementById('noiseLevel').addEventListener('input', function() {
            document.getElementById('noiseLevelValue').textContent = this.value + '%';
        });

        function handleFiles(files) {
            currentFiles = Array.from(files).filter(file => {
                const isAudio = file.type.match('audio.*') || 
                               file.name.toLowerCase().match(/\.(wav|mp3|flac|m4a|aac)$/);
                return isAudio;
            });
            
            if (currentFiles.length === 0) {
                showError('–í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã!');
                return;
            }

            updateFileList();
            updateButtons();
            
            const totalSize = currentFiles.reduce((sum, file) => sum + file.size, 0);
            showSuccess(`‚úÖ –í—ã–±—Ä–∞–Ω–æ ${currentFiles.length} —Ñ–∞–π–ª–æ–≤ (${(totalSize/1024/1024).toFixed(1)} MB)`);
            
            if (currentFiles.length > 5) {
                showSuccess('üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Ç–æ–∫–æ–≤—É—é –∑–∞–≥—Ä—É–∑–∫—É –¥–ª—è –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ñ–∞–π–ª–æ–≤!');
            }
        }

        function updateFileList() {
            const fileItems = document.getElementById('fileItems');
            const fileList = document.getElementById('fileList');
            const fileCount = document.getElementById('fileCount');
            
            fileItems.innerHTML = '';
            currentFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    ${index + 1}. ${file.name} (${(file.size/1024/1024).toFixed(1)} MB)
                `;
                fileItems.appendChild(fileItem);
            });
            
            fileCount.textContent = currentFiles.length;
            fileList.style.display = currentFiles.length > 0 ? 'block' : 'none';
        }

        function updateButtons() {
            const hasFiles = currentFiles.length > 0;
            document.getElementById('simpleBtn').disabled = !hasFiles || isProcessing;
            document.getElementById('streamBtn').disabled = !hasFiles || isProcessing;
        }

        function clearFiles() {
            currentFiles = [];
            document.getElementById('fileInput').value = '';
            updateFileList();
            updateButtons();
            showSuccess('–§–∞–π–ª—ã –æ—á–∏—â–µ–Ω—ã');
        }

        async function processFilesSimple() {
            if (currentFiles.length === 0 || isProcessing) return;
            
            if (currentFiles.length > 5) {
                showError('–î–ª—è –±–æ–ª–µ–µ —á–µ–º 5 —Ñ–∞–π–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ—Ç–æ–∫–æ–≤—É—é –∑–∞–≥—Ä—É–∑–∫—É!');
                return;
            }
            
            await processWithMethod('simple');
        }

        async function startStreamingUpload() {
            if (currentFiles.length === 0 || isProcessing) return;
            
            await processWithMethod('stream');
        }

        async function processWithMethod(method) {
            isProcessing = true;
            showLoading(true);
            updateButtons();
            
            try {
                if (method === 'simple') {
                    await processSimple();
                } else {
                    await processStreaming();
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞:', err);
                showError(err.message);
            } finally {
                isProcessing = false;
                showLoading(false);
                updateButtons();
            }
        }

        async function processSimple() {
            const formData = new FormData();
            
            currentFiles.forEach(file => {
                formData.append('files', file);
            });
            
            formData.append('noise_level', document.getElementById('noiseLevel').value / 100);

            const response = await fetch('/upload', { 
                method: 'POST', 
                body: formData 
            });

            await handleResponse(response);
        }

        async function processStreaming() {
            const startResponse = await fetch('/start_upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    file_count: currentFiles.length,
                    noise_level: document.getElementById('noiseLevel').value / 100
                })
            });
            
            const startData = await startResponse.json();
            if (!startResponse.ok) throw new Error(startData.error);
            
            currentSessionId = startData.session_id;
            console.log(`üöÄ –ù–∞—á–∞—Ç–∞ –ø–æ—Ç–æ–∫–æ–≤–∞—è —Å–µ—Å—Å–∏—è: ${currentSessionId}`);
            
            const CHUNK_SIZE = 3;
            for (let i = 0; i < currentFiles.length; i += CHUNK_SIZE) {
                const chunk = currentFiles.slice(i, i + CHUNK_SIZE);
                const chunkFormData = new FormData();
                
                chunk.forEach(file => {
                    chunkFormData.append('files', file);
                });
                
                const chunkResponse = await fetch(`/upload_chunk/${currentSessionId}`, {
                    method: 'POST',
                    body: chunkFormData
                });
                
                const chunkData = await chunkResponse.json();
                if (!chunkResponse.ok) {
                    console.error(`–û—à–∏–±–∫–∞ –≤ —á–∞–Ω–∫–µ ${i}:`, chunkData.error);
                    continue;
                }
                
                document.getElementById('chunkInfo').textContent = 
                    `–û–±—Ä–∞–±–æ—Ç–∞–Ω —á–∞–Ω–∫: ${chunkData.successful_in_chunk}/${chunkData.processed_in_chunk} —Ñ–∞–π–ª–æ–≤`;
                
                await updateProgress();
                
                if (i + CHUNK_SIZE < currentFiles.length) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            await getFinalResults();
        }

        async function updateProgress() {
            if (!currentSessionId) return;
            
            try {
                const progressResponse = await fetch(`/get_progress/${currentSessionId}`);
                const progressData = await progressResponse.json();
                
                if (progressResponse.ok) {
                    const percent = (progressData.processed / progressData.total) * 100;
                    document.getElementById('progressFill').style.width = percent + '%';
                    document.getElementById('progressText').textContent = 
                        `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${progressData.processed}/${progressData.total} —Ñ–∞–π–ª–æ–≤`;
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', err);
            }
        }

        async function getFinalResults() {
            if (!currentSessionId) return;
            
            try {
                const resultsResponse = await fetch(`/get_results/${currentSessionId}`);
                await handleResponse(resultsResponse);
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:', err);
                throw err;
            }
        }

        async function handleResponse(response) {
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON:', text.substring(0, 500));
                throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
            }

            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || `–û—à–∏–±–∫–∞: ${response.status}`);
            }
            
            displayBatchResults(data);
            showSuccess(`‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${data.summary.successful} –∏–∑ ${data.summary.total} —Ñ–∞–π–ª–æ–≤!`);
        }

        function displayBatchResults(data) {
            const summaryContent = document.getElementById('summaryContent');
            summaryContent.innerHTML = `
                <p><strong>–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤:</strong> ${data.summary.total}</p>
                <p><strong>–£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ:</strong> ${data.summary.successful}</p>
                <p><strong>–° –æ—à–∏–±–∫–∞–º–∏:</strong> ${data.summary.failed}</p>
                ${data.failed_files && data.failed_files.length > 0 ? `
                    <p><strong>–§–∞–π–ª—ã —Å –æ—à–∏–±–∫–∞–º–∏:</strong></p>
                    <ul>
                        ${data.failed_files.map(f => `<li>${f.filename}: ${f.error}</li>`).join('')}
                    </ul>
                ` : ''}
            `;
            
            // –ü–û–ö–ê–ó–´–í–ê–ï–ú –ö–ù–û–ü–ö–ò –°–ö–ê–ß–ò–í–ê–ù–ò–Ø
            document.getElementById('downloadButtons').style.display = 'block';
            document.getElementById('batchSummary').style.display = 'block';
            
            const resultsGrid = document.getElementById('resultsGrid');
            resultsGrid.innerHTML = '';
            
            if (data.processed_files && data.processed_files.length > 0) {
                data.processed_files.forEach((fileResult, index) => {
                    const fileSection = document.createElement('div');
                    fileSection.className = 'file-section';
                    fileSection.innerHTML = `
                        <h3>üéµ ${fileResult.filename} (${fileResult.duration ? fileResult.duration.toFixed(1) + '—Å–µ–∫' : ''})</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                            ${createAudioCard('–û—Ä–∏–≥–∏–Ω–∞–ª', 'original', fileResult, data.noise_reduction_level)}
                            ${createAudioCard('–û—á–∏—â–µ–Ω–Ω—ã–π', 'denoised', fileResult, data.noise_reduction_level)}
                            ${createAudioCard('–£–¥–∞–ª–µ–Ω–Ω—ã–π —à—É–º', 'residual', fileResult, data.noise_reduction_level)}
                        </div>
                    `;
                    
                    resultsGrid.appendChild(fileSection);
                });
            }
            
            document.getElementById('results').style.display = 'block';
        }

        function createAudioCard(title, key, fileResult, noiseLevel) {
            const spectrogram = fileResult.spectrograms && fileResult.spectrograms[key];
            const displayTitle = key === 'denoised' ? `${title} (${Math.round(noiseLevel * 100)}%)` : title;
            
            return `
                <div class="result-card">
                    <h4>${displayTitle}</h4>
                    <div class="spectrogram-img">
                        ${spectrogram ? 
                            `<img src="${spectrogram}" alt="${title}" style="max-width: 100%; height: auto;">` :
                            '<div>–°–ø–µ–∫—Ç—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞</div>'
                        }
                    </div>
                    ${fileResult.preview_audio && fileResult.preview_audio[key] ? `
                        <audio controls class="audio-player">
                            <source src="data:audio/wav;base64,${fileResult.preview_audio[key]}" type="audio/wav">
                        </audio>
                    ` : ''}
                    <div>
                        ${fileResult.files && fileResult.files[`${key}_audio`] ? 
                            `<a href="${fileResult.files[`${key}_audio`]}" class="download-btn" download>–°–∫–∞—á–∞—Ç—å ${title}</a>` :
                            ''
                        }
                    </div>
                </div>
            `;
        }

        // –§–£–ù–ö–¶–ò–Ø –°–ö–ê–ß–ò–í–ê–ù–ò–Ø –°–ü–ï–ö–¢–†–û–ì–†–ê–ú–ú
        function downloadSpectrograms(type) {
            if (!currentSessionId) {
                showError('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è');
                return;
            }
            
            const url = `/download_spectrograms/${currentSessionId}/${type}`;
            const link = document.createElement('a');
            link.href = url;
            link.download = '';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccess(`üì• –ù–∞—á–∞—Ç–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ ${getSpectrogramTypeName(type)}`);
        }

        function getSpectrogramTypeName(type) {
            const names = {
                'original': '–∏—Å—Ö–æ–¥–Ω—ã—Ö —Å–ø–µ–∫—Ç—Ä–æ–≥—Ä–∞–º–º',
                'denoised': '–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–ø–µ–∫—Ç—Ä–æ–≥—Ä–∞–º–º', 
                'residual': '—Å–ø–µ–∫—Ç—Ä–æ–≥—Ä–∞–º–º —à—É–º–æ–≤'
            };
            return names[type] || '—Å–ø–µ–∫—Ç—Ä–æ–≥—Ä–∞–º–º';
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('simpleBtn').disabled = show;
            document.getElementById('streamBtn').disabled = show;
        }

        function showError(msg) {
            document.getElementById('error').textContent = msg;
            document.getElementById('error').style.display = 'block';
            document.getElementById('success').style.display = 'none';
        }

        function showSuccess(msg) {
            document.getElementById('success').textContent = msg;
            document.getElementById('success').style.display = 'block';
            document.getElementById('error').style.display = 'none';
        }
    </script>
</body>
</html>